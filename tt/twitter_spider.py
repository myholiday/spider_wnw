#!/usr/bin/env python# -*- coding: utf-8 -*-# Created by spider3 on 2018/4/8# Copyright (c) 2018 spider3. All rights reserved.import requestsimport timeimport jsonfrom PIL import Imagefrom lxml import etreefrom retry import retryfrom selenium import webdriverfrom selenium.webdriver.chrome.options import Optionsfrom selenium.webdriver.common.by import Byfrom selenium.webdriver.support.ui import WebDriverWaitfrom selenium.webdriver.support import expected_conditions as ECfrom selenium.webdriver.common.action_chains import ActionChainsfrom selenium.webdriver.common.keys import Keysfrom selenium.webdriver.common.desired_capabilities import DesiredCapabilitiesheaders = {    "referer": "https://www.google.com/",    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36'}@retry(10)def get_ids():    response = requests.get('https://twitter.com/realDonaldTrump', headers=headers,)    html = etree.HTML(response.text)    nodes = html.xpath('//li[@class="js-stream-item stream-item stream-item\n"]')    ids = [node.xpath('./@data-item-id')[0] for node in nodes]    print(ids)    return ids[:]def save_newest_id(id):    with open('./newest_id.txt', 'w') as f:        f.write(id)def judge_is_send(ids):    with open('./newest_id.txt', 'r') as f:        newest_id = f.read()    try:        if newest_id == ids[0]:            return True    except Exception as e:        print("没有获取到id，list index out of range")        print(e)        return True    return Falsedef get_1st_twitter(uid):    base_url = 'https://twitter.com/realDonaldTrump/status/{}?conversation_id={}'.format(uid, uid)    response = requests.get(base_url, headers=headers,)    html = etree.HTML(response.text)    div = html.xpath('//div[@class="js-tweet-text-container"]/text()')    print(div)    p = html.xpath('//p[@class="TweetTextSize TweetTextSize--jumbo js-tweet-text tweet-text"]/text()')    p2 = "".join(p)    if len(p2) > 141:  # too long        print(p2)        return p2[:135]+"..."    print(p)    return pdef get_twitter_pic(driver, uid):    driver.get('https://twitter.com/realDonaldTrump/status/{}?conversation_id={}'.format(uid, uid))    try:  # 等待        element = WebDriverWait(driver, 15).until(            EC.presence_of_element_located((By.ID, "permalink-overlay"))        )        print("Twitter出现啦")    except Exception as e:        print(e)        print("Twitter没出现")    print('耐心等待，可能会有图片哦!')    time.sleep(5)  # 等待缓冲，可能有视频图片    driver.save_screenshot('./pics/{}.png'.format(uid))    print("OK")    try:        element = driver.find_element_by_xpath('//*[@id="react-root"]/div/main/div/div[1]/div/div/div/div/div/section/div/div/div/div[1]')    except:        element = driver.find_element_by_xpath('//*[@id="permalink-overlay-dialog"]/div[3]/div/div/div[1]/div[1]')    try:  # 转发自己？        element = driver.find_element_by_xpath('//div[@class="permalink-inner permalink-tweet-container ThreadedConversation ThreadedConversation--permalinkTweetWithAncestors"]')    except:        pass    left = element.location["x"]    top = element.location["y"]    right = element.location['x'] + element.size['width']    bottom = element.location['y'] + element.size['height']    im = Image.open('./pics/{}.png'.format(uid))    im = im.crop((left, top, right, bottom))    im.save('./pics/{}.png'.format(uid))    print('保存图片成功', uid)def assign_weibo(driver):    driver.get('https://weibo.cn/')    time.sleep(3)    driver.delete_all_cookies()    # 读取cookies    with open("./cookies.json", "r") as f:        list_cookies = json.loads(f.read())    for cookie in list_cookies:        driver.add_cookie(cookie)    driver.get('https://weibo.cn/')    # 验证码    while "Donald-J-Trum" not in driver.page_source:  # without login, then login        print("cookies登录失败")        time.sleep(3)    print("cookies登录成功")    # driver.get('https://login.sina.com.cn/signup/signin.php')    # try:    #     element = WebDriverWait(driver, 15).until(    #         EC.presence_of_element_located((By.ID, "username"))    #     )    #    #     print('get it ')    # except Exception as e:    #     print(e)    # driver.find_element_by_xpath('//*[@id="username"]').send_keys(account)    # driver.find_element_by_xpath('//*[@id="password"]').send_keys(password)    # driver.find_element_by_xpath('//*[@id="vForm"]/div[2]/div/ul/li[7]/div[1]/input').click()    # time.sleep(1)  # 等待yzm    # # 验证码    # while "login" in driver.current_url:    #     driver.save_screenshot('./yzm.png')    #     element = driver.find_element_by_xpath('//*[@id="check_img"]')    #     left = element.location["x"]    #     top = element.location["y"]    #     right = element.location['x'] + element.size['width']    #     bottom = element.location['y'] + element.size['height']    #     im = Image.open('./yzm.png')    #     im = im.crop((left, top, right, bottom))    #     im.save('./yzm.png')    #     print('切割验证码成功！')    #    #     yzm = ydm()    #     time.sleep(2)    #     try:    #         driver.find_element_by_xpath('//*[@id="door"]').clear()    #         driver.find_element_by_xpath('//*[@id="door"]').send_keys(yzm)    #         driver.find_element_by_xpath('//*[@id="vForm"]/div[2]/div/ul/li[7]/div[1]/input').click()    #     except Exception as e:    #         print(e)def sent_message(driver, newest_id):    driver.get('https://weibo.cn/')    current_url = driver.current_url    while "Donald-J-Trum" not in driver.page_source:  # without login, then login        assign_weibo(driver)        driver.get('https://weibo.cn/')        time.sleep(2)    try:        WebDriverWait(driver, 15).until(            EC.presence_of_element_located((By.ID, "pagelist"))        )    except Exception as e:        print("没等到最下面出现")        print(e)    try:        driver.find_element_by_xpath('/html/body/div[6]/form/div/input[4]').click()    except Exception as e:        driver.find_element_by_xpath('/html/body/div[5]/form/div/input[4]').click()    WebDriverWait(driver, 15).until(EC.presence_of_element_located((By.ID, "top")))    twitter_text = get_1st_twitter(newest_id)    if not twitter_text:        twitter_text = "forwording"    driver.find_element_by_xpath('//*[@id="mblogform"]/div/textarea').clear()    driver.find_element_by_xpath('//*[@id="mblogform"]/div/textarea').send_keys(twitter_text)    driver.find_element_by_name("pic").send_keys(r'F:\spider_wnw\spider_wnw\tt\pics\{}.png'.format(newest_id))  # 图片绝对路径    time.sleep(1)  # upload pic    driver.find_element_by_xpath('//*[@id="mblogform"]/div/input[3]').click()    time.sleep(1)    # if ",将自动分为2条发布." in driver.page_source:    #     driver.find_element_by_xpath("/html/body/form/div[2]/input[1]").click()    #     print("太长，分为两条发！")    print("发微博完成完成")    save_newest_id(newest_id)    print("保存最新id完成{}".format(newest_id))    # driver.get('https://weibo.com')    # current_url = driver.current_url    # if 'signin' in current_url or "trump" not in driver.page_source:  # without login, then login    #     assign_weibo(driver)    #     driver.get('https://weibo.com')    # try:    #     WebDriverWait(driver, 15).until(    #         EC.presence_of_element_located((By.ID, "v6_pl_content_homefeed"))    #     )    # except Exception as e:    #     print(e)    #    #    # driver.find_element_by_xpath('//*[@id="v6_pl_content_publishertop"]/div/div[2]/textarea').send_keys(newest_id)    # driver.find_element_by_name("pic1").send_keys(r'./{}.png'.format(newest_id))    # time.sleep(6)  # upload pic    # driver.find_element_by_xpath('//*[@id="v6_pl_content_publishertop"]/div/div[3]/div[1]/a').click()    #    # print("发送完成")    # save_newest_id(newest_id)    # print("保存最新id")def ydm():    # 云打码    # data = {'method': 'upload', 'username': 'qq6442742', 'password': 'a1354357072', 'appid': 1,    #         'appkey': '22cc5376925e9387a23cf797cb9ba745', 'codetype': '1005', 'timeout': 60}    #    # with open('./yzm.png', 'rb') as f:    #     b = f.read()    # response = requests.post('http://api.yundama.com/api.php', data=data, files={'file': b})    # print(response.text)    # response = json.loads(response.text)    # return response['text']    # 云速    url = 'http://api.ysdm.net/create.json'    # b = Image.open('yzm.png')    with open('./yzm.png', 'rb') as f:        b = f.read()    data = {        'Action': 'upload',        'username': 'qq584548711',        'password': 'qwertyuiop',        'typeid': '3050',        'timeout': '90',        'softid': '1',        'softkey': 'b40ffbee5c1cf4e38028c197eb2fc751',        }    response = requests.post(url, data=data, files={'image': b})    print(response.text)    response = json.loads(response.text)    return response['Result']@retry(tries=5)def start(driver):    while True:        ids = get_ids()        judgement = judge_is_send(ids)        if judgement:            print("没有新推，休息2分钟", time.strftime('%Y-%m-%d  %H:%M:%S'))            time.sleep(120)        else:            newest_id = ids[0]            get_twitter_pic(driver, newest_id)            sent_message(driver, newest_id)            time.sleep(60)def main():    # chrome_options = Options()    # chrome_options.add_argument('--headless')    # driver = webdriver.Chrome(chrome_options=chrome_options)    # driver = webdriver.PhantomJS(executable_path=r'C:\Program Files\phantomjs-2.1.1-windows\bin\phantomjs.exe')    # driver.viewportSize = {'width': 1024, 'height': 800}    # driver.maximize_window()    driver = webdriver.Chrome()    start(driver)    """        account = '13071686002'    password = 'trump666666'    driver.get('https://passport.weibo.cn/signin/login')    """if __name__ == '__main__':    main()