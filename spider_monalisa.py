#!/usr/bin/env python# -*- coding: utf-8 -*-# Created by spider3 on 2018/3/6# Copyright (c) 2018 spider3. All rights reserved.import requestsfrom lxml import etreeimport jsonfrom get_address_by_coord import get_address_by_coordfrom get_region_id import get_region_idclass Monalisa_spider(object):    def __init__(self):        self.url = "http://www.monalisa.com.cn/store.html"        self.text = self.__get_html()    # 获取网页文本    def __get_html(self):        response = requests.get(self.url)        return response.text    # 解析数据    def parse_detail(self):        html = etree.HTML(self.text)        nodes = html.xpath('//ul[@class="mapList"]/li')        data_json = {"detail": []}        for node in nodes:            tmp = {}            number = node.xpath("./span/text()")[0]            name = node.xpath('./div/a/text()')[0]            address = node.xpath('./div/p/text()')[0]            phone_number = node.xpath('./div/em/text()')[0].strip()            tmp["number"] = number            tmp["address"] = address            tmp["name"] = name            tmp["phone_number"] = phone_number            tmp["ten_coord"] = self.get_coord(address)            tmp["jw_coord"] = self.get_jw_coord(tmp["ten_coord"]["x"] + "," + tmp["ten_coord"]["y"])            # 获取地址所在区            region_data = get_address_by_coord(x=tmp["ten_coord"]["x"],y=tmp["ten_coord"]["y"])            district = region_data['address_detail']['district']            # 根据区信息获取省市区编号            print(district)            regionid1, regionid2, regionid3 = get_region_id(district)            tmp['regionid1'] = regionid1            tmp['regionid2'] = regionid2            tmp['regionid3'] = regionid3            data_json["detail"].append(tmp)            print(tmp)        # 保存成json文件        with open("./data/monalisa1.json", "w") as f:            f.write(json.dumps(data_json, ensure_ascii=False))    # 根据百度api获取十字坐标    def get_coord(self, address):        data = {"qt": "gc", "wd": address}        response = requests.get("http://api.map.baidu.com", params=data)        response_json = json.loads(response.text)        coord = response_json["content"]["coord"]        return coord    # 根据百度api把十字左边转换成经纬度坐标    def get_jw_coord(self, coord):        data = {"from": 6, "to": 5, "ak": "mDml72vqmPtHmZHl7tus153lx9e1pg8A", "coords": coord}        response = requests.get("http://api.map.baidu.com/geoconv/v1/", params=data)        response_json = json.loads(response.text)        if response_json["status"] == 0:            return response_json["result"][0]        # print("转换失败")        # self.get_jw_coord(coord)def main():    mon = Monalisa_spider()    mon.parse_detail()if __name__ == '__main__':    main()