#!/usr/bin/env python# -*- coding: utf-8 -*-# Created by spider3 on 2018/6/20# Copyright (c) 2018 spider3. All rights reserved.import pymysqlimport timeconnection = pymysql.connect(host='localhost', user='root', password='root', db='feigo_data', port=3306, charset='utf8')def get_need_update_data():    sql = "SELECT `id`,`region_id_3`,`longitude`,`latitude` FROM `feigo_shops` WHERE `region_id_3`!=0 AND `id`>=1456801 AND `id`<1600000;"    # sql = "SELECT `id`,`region_id_3`,`longitude`,`latitude` FROM `feigo_shops` WHERE `region_id_3`!=0 AND `region_id_2`=430100;"    with connection.cursor() as cursor:        cursor.execute(sql)        data = cursor.fetchall()    # print(data)    print(len(data))    return datadef get_all_shanquan_list_by_quid(region_id_3):    sql = "SELECT `lng`,`lat`,`id` FROM `feigo_regions` WHERE `parent_id`={};".format(        region_id_3)  # 查找parent_id为商圈id的地区    with connection.cursor() as cursor:        cursor.execute(sql)        data = cursor.fetchall()    # print(data)    print(len(data))    return datadef get_cloest_shangquan_id(shangquan_coord_list, lng, lat):    # 如果没有商圈    if len(shangquan_coord_list) == 0:        return None    cloest_num = 99999999  # 最近距离    cloest_id = 0  # 最近距离的id    print(shangquan_coord_list)    for shangquan_coord in shangquan_coord_list:        distance = ((float(lng) - float(shangquan_coord[0])) ** 2 + (float(lat) - float(shangquan_coord[1])) ** 2)        print(distance, shangquan_coord[2])        if distance < cloest_num:  # 如果比最小的距离还小就赋值            cloest_num = distance            cloest_id = shangquan_coord[2]            print(cloest_id, cloest_num)    if cloest_num < 0.3 and cloest_id != 0:  # 距离小于临街距离        return cloest_id    return Nonedef write_sql(region_id_4, shop_id):    with open("./140-160w.sql", "a", encoding="utf-8") as f:        sql = "UPDATE `feigo_shops` SET `region_id_4`={} WHERE `id`={};\n".format(region_id_4, shop_id)        f.write(sql)def start():    need_update_data = get_need_update_data()    for one_need in need_update_data[:]:  # `id`,`region_id_3`,`longitude`,`latitude`        shanquan_list = get_all_shanquan_list_by_quid(one_need[1])        try:  # 遇到错误            cloest_shangquan_id = get_cloest_shangquan_id(shanquan_list, one_need[2], one_need[3])        except ValueError as e:            print(e)            write_sql("null", one_need[0])            continue        if cloest_shangquan_id:            write_sql(cloest_shangquan_id, one_need[0])        else:            write_sql("null", one_need[0])        time.sleep(0.2)def main():    # get_need_update_data()    # get_all_shanquan_list_by_quid(*(759770, 411426,0,0))    start()if __name__ == '__main__':    main()