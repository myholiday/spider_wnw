#!/usr/bin/env python# -*- coding: utf-8 -*-# Created by spider3 on 2018/3/15# Copyright (c) 2018 spider3. All rights reserved.import jsonimport requestsfrom lxml import etreefrom utils.get_baidu_coord import BaiduCoordfrom utils.get_address_by_ten_coord import get_address_by_ten_coordfrom utils.get_region_id import get_region_id#  获取地址iddef get_areaids():    url = 'http://pro.panasonic.cn/service/introduce.html'    response = requests.get(url)    html = etree.HTML(response.text)    areaids = html.xpath('//select[@id="areaid"]')[0]    areaids = areaids.xpath('./option/@value')[1:]    print(areaids)    return areaids# 根据地址id获取门店li = []def get_data(areaid, page):    print("正在获取{}第{}页".format(areaid, page))    url = 'http://pro.panasonic.cn/service/saleNet.html'    page = page    data = {        'search_type': 0,        'cityid': 0,        'life_id': 0,        'areaid': areaid,        'page': page    }    response = requests.get(url, data)    if '没有找到您想要的结果' in response.text:        return data    page += 1    html = etree.HTML(response.text)    nodes = html.xpath('//table/tr')[1:]    for node in nodes:        tmp = {}        tmp["city"] = node.xpath('./td[1]/text()')[0]        tmp['name'] = node.xpath('./td[2]/text()')[0]        tmp['address'] = node.xpath('./td[3]/text()')[0]        try:            tmp['phone_number'] = node.xpath('./td[4]/text()')[0]        except:            tmp['phone_number'] = 0        li.append(tmp)    try:        arrow = html.xpath('//div[@class="hous_right l sv_sale"]/ul/li')[-1]    except:  # 没有翻页的页码也停        return    # 有东西就停    if arrow.xpath('./a/text()'):        return    get_data(areaid, page)def spider():    areaids = get_areaids()    for areaid in areaids:        get_data(areaid, 1)def save():    with open('../data/panasonic.json', 'w') as f:        f.write(json.dumps(li, ensure_ascii=False))def add_detail():    with open('../data/panasonic.json', 'r') as f:        data = json.loads(f.read())    print(len(data))    i = 110456    for one_data in data:        one_data['id'] = i        i += 1        one_data['preview_image'] = 'brands_images/full/1421.jpg'        one_data['brand_id'] = 1421        one_data['create_time'] = 'NOW()'        # 获取经纬度        try:            bc = BaiduCoord(one_data['address'])            ten_coord = bc.get_ten_coord()            jw_coord = bc.get_jw_coord()            one_data['longitude'] = jw_coord['x']            one_data['latitude'] = jw_coord['y']            qu = get_address_by_ten_coord(ten_coord['x'], ten_coord['y'])            qu = qu['address_detail']['district']            regionid1, regionid2, regionid3 = get_region_id(qu)            one_data['region_id_1'] = regionid1            one_data['region_id_2'] = regionid2            one_data['region_id_3'] = regionid3        except:            one_data['longitude'] = 0            one_data['latitude'] = 0            one_data['region_id_1'] = 0            one_data['region_id_2'] = 0            one_data['region_id_3'] = 0        print(one_data)    with open("../data/panasonic_add_detail.json", 'w') as f:        f.write(json.dumps(data, ensure_ascii=False))def main():    # spider()  # 爬取    # save()  # 并保存原始数据    add_detail()if __name__ == '__main__':    main()